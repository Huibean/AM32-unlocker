# config for openocd for STM32F051 MCUs
source [find interface/stlink.cfg]
source [find target/stm32g0x.cfg]

# use -gdb-max-connections to allow for live watch in vscode
$_TARGETNAME configure -work-area-phys 0x20000000 -work-area-size $_WORKAREASIZE -work-area-backup 0 -gdb-max-connections 4
init
reset halt

set FLASH_OPTR [mrw 0x40022020]
echo "FLASH_OPTR [format 0x%08x $FLASH_OPTR]"

set OPT_RDP [expr {($FLASH_OPTR & 0xFF)}]
echo "OPT_RDP [format 0x%02x $OPT_RDP]"

set PCROP_START [mrw 0x40022024]
set PCROP_END [mrw 0x40022028]
echo "PRROP [format 0x%08x $PCROP_START] [format 0x%08x $PCROP_END]"

set WP_START [mrw 0x4002202C]
set WP_END [mrw 0x40022030]
echo "WP [format 0x%08x $WP_START] [format 0x%08x $WP_END]"

if { $OPT_RDP != 0xAA } {
   echo "unlock flash"
   mww 0x40022008 0x45670123
   mww 0x40022008 0xCDEF89AB

   echo "unlock option"
   mww 0x4002200C 0x08192A3B
   mww 0x4002200C 0x4C5D6E7F

   set NEW_OPTR [expr {($FLASH_OPTR & ~0xFF) | 0xAA}]
   echo "NEW_OPTR [format 0x%08x $NEW_OPTR]"

   echo "writing OPTR"
   mww 0x40022020 $NEW_OPTR

   echo "disabling protections"
   mww 0x40022024 0
   mww 0x40022028 0x80000000
   mww 0x4002202C 0x003f003f
   mww 0x40022030 0x003f003f
   mww 0x40022034 0
   mww 0x40022038 0

   echo "send OPTSTRT"
   mww 0x40022014 0x20000

   sleep 2000

   echo "option reload"
   mww 0x40022014 0x08000000
   sleep 5000
   reset halt
}

echo "erase 3 bootloader sectors"
flash erase_sector 0 0 3
sleep 100

echo "erase eeprom sector"
flash erase_sector 0 31 31
sleep 100

echo "Load bootloader"
flash write_bank 0 g071/bl.bin

echo "verify bootloader"
flash verify_bank 0 g071/bl.bin

exit
